# TESTING.md

> 用途：把每个角色的关键流程写成“可回放的剧本”，用于自测、联调、回归和复盘。
>
> 使用方式：每次发版/修 bug 前后，把相关用例从“未测”勾到“通过/失败”，并补齐“证据”。

---

## 0. 测试信息（每次测试先填）

- **测试日期**：YYYY-MM-DD
- **测试人**：
- **环境**：
  - **后端**：本地 / 测试 / 生产
  - **小程序**：开发版 / 体验版 / 正式版
- **版本信息**：
  - **后端 commit**：
  - **前端 commit**：
  - **Docker image id（如适用）**：
- **关键配置核对**（只记录尾号/是否一致，不要贴 secret）：
  - **WX_APPID**：
  - **订阅模板ID**：
  - **数据库**：
- **测试数据标识**（方便回查）：
  - **application_id**：
  - **match_no**：
  - **openid 尾号**：

---

## 1. 角色与主流程概览（回归时先扫一遍）

- **选手**：登录 -> 报名 -> 查询/我的报名 -> 订阅审核通知 -> 下载证书
- **管理员**：登录 -> 查询报名 -> 审核通过/退回 -> 批量生成/下载证书
- **系统**：缓存/模板/环境变量/部署正确性

---

## 2. 选手端（小程序）用例

### U-01 微信登录/授权

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：
  - 小程序 AppID 与后端 `WX_APPID` 一致
  - 后端容器/服务环境变量已注入（`WX_APPID/WX_SECRET` 非空）
- **步骤**：
  1. 打开小程序 -> 触发登录
  2. 允许授权（如有弹窗）
- **预期**：
  - 登录成功进入首页/报名页
  - 后端无 `40029 invalid code`
- **证据（至少一项）**：
  - 截图路径：
  - 后端日志关键字：
  - 备注：

### U-02 报名提交（首次报名）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：
  - 已登录
  - 准备一套完整报名信息（学校/联系人/队员等）
- **步骤**：
  1. 进入报名页 -> 填写必填项
  2. 点击“提交报名”
- **预期**：
  - 前端提示提交成功
  - 后端创建 `Application` 记录（状态=待审核）
- **证据**：
  - application_id：
  - 截图路径：
  - DB/接口返回：

### U-03 报名提交（字段校验与错误提示）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. 清空一个必填项（如手机号）
  2. 点击提交
- **预期**：
  - 前端明确提示哪项缺失/格式错误
  - 后端不创建脏数据
- **证据**：
  - 截图路径：

### U-04 查询报名/我的报名列表

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：已存在至少 1 条报名记录
- **步骤**：
  1. 打开“查询/我的报名”
  2. 查看列表与详情
- **预期**：
  - 能看到刚才提交的记录
  - 状态字段正确（待审核/通过/退回）
- **证据**：
  - 截图路径：

### U-05 订阅审核通知（requestSubscribeMessage）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：
  - 小程序后台“订阅消息-我的模板”存在对应模板ID
  - 前端 `tmplId` 与后台一致
- **步骤**：
  1. 在报名流程中点击订阅
  2. 选择“允许”
- **预期**：
  - 提示订阅成功
  - 不出现 `No template data return`
- **证据**：
  - 截图路径：
  - 模板ID：

### U-06 下载/打开证书（学生证书 PDF）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：
  - 管理员已审核通过，并填写了获奖等级
  - 如有缓存，先清理 `data/generated_certs/player/*.pdf`（生产慎用）
- **步骤**：
  1. 在小程序中进入证书入口
  2. 点击“打开证书/下载证书”
- **预期**：
  - 能成功打开/下载 PDF
  - PDF 文字位置/内容正确（如“赛别”不带末尾“赛”）
- **证据**：
  - PDF 截图路径：
  - application_id：

---

## 3. 管理端（管理员）用例

### A-01 管理员登录

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. 打开管理端登录页
  2. 输入账号密码登录
- **预期**：
  - 登录成功
  - 能进入报名列表
- **证据**：
  - 截图路径：

### A-02 报名列表/详情查看

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：存在报名记录
- **步骤**：
  1. 进入报名列表
  2. 搜索/筛选某条记录
  3. 进入详情
- **预期**：
  - 列表字段显示正确
  - 详情字段完整
- **证据**：
  - 截图路径：

### A-03 审核通过（触发订阅消息）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **前置条件**：选手端已订阅（U-05）
- **步骤**：
  1. 管理端打开某条报名
  2. 点击“通过”，填写获奖等级等信息
- **预期**：
  - 报名状态变为“通过”
  - 后端发送订阅消息成功（日志 `wx_subscribe_send result`)
  - 订阅消息字段映射正确：
    - **赛事名称**
    - **报名情况**
- **证据**：
  - 后端日志片段：
  - 微信通知截图：

### A-04 审核退回（触发订阅消息/邮件）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. 点击“退回/驳回”，填写原因
- **预期**：
  - 状态为“退回”
  - 通知送达（订阅消息/邮件，取决于配置）
- **证据**：
  - 截图/日志：

---

## 4. 证书/文件（后端）用例

### C-01 单个证书生成接口（学生）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **相关接口**：`GET /api/certificate/generate/<application_id>`
- **步骤**：
  1. 请求接口生成 PDF
- **预期**：
  - 返回 PDF
  - 文件名字段完整
- **证据**：
  - application_id：
  - 返回码/大小：

### C-02 批量生成/打包（管理员）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. 管理端选择批量生成/下载
- **预期**：
  - ZIP 下载成功
  - 文件数量与预期一致
- **证据**：
  - ZIP 文件名/大小：

### C-03 缓存命中/清理策略

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **检查点**：
  - 修改模板/字段后，是否需要清理 `data/generated_certs/*/*.pdf`
  - 缓存命中是否导致“看起来没更新”
- **证据**：
  - 备注：

---

## 5. 配置/部署回归（Docker/环境变量）

### D-01 环境变量注入检查（容器内）

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. 检查容器内 env 是否存在关键配置
- **命令（示例）**：
  - `docker inspect competition-web --format '{{range .Config.Env}}{{println .}}{{end}}' | grep '^WX_APPID='`
- **预期**：
  - `WX_APPID`、数据库等关键变量均存在且正确
- **证据**：
  - 输出片段：

### D-02 build/up 后镜像版本确认

- **状态**：- [ ] 未测  - [ ] 通过  - [ ] 失败
- **步骤**：
  1. build 后确认容器使用的 image id 是最新
- **证据**：
  - image id：

---

## 6. 回归清单（发版前 5 分钟快速检查）

- [ ] U-01 微信登录成功
- [ ] U-02 能提交报名
- [ ] A-03 审核通过成功
- [ ] U-05 订阅不报错，能收到通知
- [ ] U-06 证书能打开且关键字段正确
- [ ] D-01 关键 env 已注入

---

## 7. 缺陷记录（每个 bug 一条）

> 建议每次遇到问题都按这个格式记录，未来复盘/写简历都能直接用。

### BUG-YYYYMMDD-001 标题

- **现象**：
- **复现步骤**：
- **期望结果**：
- **实际结果**：
- **影响范围**：
- **定位过程**：
- **根因**：
- **修复方案**：
- **验证方式**：
- **相关提交/版本**：
- **证据（截图/日志）**：
